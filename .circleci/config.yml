version: 2.1
executors:
  python27-jessie-node:
    docker:
      - image: circleci/python:2.7.15-jessie-node-browsers
    working_directory: /tmp

jobs:
  build:
    executor: python27-jessie-node
    steps:
      - checkout
      - run: |
          sudo apt-get update; sudo apt-get install libxml2-dev libxmlsec1-dev swig -y
          sudo apt-get install libgeos-dev
          npm install

          virtualenv ./venv
          . venv/bin/activate

          pip install setuptools

          # Needs mongodb > 3.2 to work 
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6
          echo "deb http://repo.mongodb.org/apt/debian jessie/mongodb-org/3.4 main" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list
          sudo apt-get update
          sudo apt-get install mongodb-org -y

          # Mirror what paver install_prereqs does.
          # After a successful build, CircleCI will
          # cache the virtualenv at that state, so that
          # the next build will not need to install them
          # from scratch again.

          pip install --exists-action w -r requirements/edx/pre.txt
          pip install --exists-action w -r requirements/edx/testing.txt

          # HACK: within base.txt stevedore had a
          # dependency on a version range of pbr.
          # Install a version which falls within that range.
          pip install --exists-action w pbr==0.9.0
          pip install --exists-action w -r requirements/edx/base.txt
          pip install --exists-action w -r requirements/edunext/base.txt
          pip install --exists-action w -r requirements/edx/paver.txt
          if [ -e requirements/edx/post.txt ]; then pip install --exists-action w -r requirements/edx/post.txt ; fi

          pip install coveralls==1.0
          pip freeze
      - persist_to_workspace:
                # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is 
                # taken to be the root directory of the workspace.
                root: .
                # Must be relative path from root
                paths:
                  - .
  test:
    executor: python27-jessie-node
    parallelism: 4
    steps:
      - attach_workspace:
          # Must be absolute path or relative path from working_directory
          at: /tmp
      - run: |
          . venv/bin/activate
          ./scripts/all-tests.sh
          # Output the installed python packages to the console to help
          # with troubleshooting any issues with python requirements.
  post:
    executor: python27-jessie-node
    steps:
      export CIRCLE_TEST_REPORTS=~/test_reports
      mkdir -p $CIRCLE_TEST_REPORTS/junit
      if [ $(find reports -type f | wc -l) -gt 0 ] ; then cp -r reports/. $CIRCLE_TEST_REPORTS/junit ; fi
      if [ -z $COVERALLS_REPO_TOKEN ]; then echo "Coveralls token not defined."; else coveralls; fi

workflows:
  version: 2.1
  btd:
    jobs:
      - build
      - test:
          requires:
            - flow
      - post:
          requires:
            - test